import json

import matplotlib.pyplot as plt
import numpy as np
from bertopic import BERTopic
from sklearn.metrics.pairwise import cosine_distances
from umap import UMAP

# =============================================================================
# # Prepare embeddings
# docs = fetch_20newsgroups(subset='all',  remove=('headers', 'footers', 'quotes'))['data'][:100]
# sentence_model = SentenceTransformer("all-MiniLM-L6-v2")
# embeddings = sentence_model.encode(docs, show_progress_bar=True)
#
# # Train BERTopic
# topic_model = BERTopic().fit(docs, embeddings)
#
# # Reduce dimensionality of embeddings, this step is optional
# reduced_embeddings = UMAP(n_neighbors=10, n_components=2, min_dist=0.0, metric='cosine').fit_transform(embeddings)
#
# # Run the visualization with the original embeddings
# topic_model.visualize_document_datamap(docs, embeddings=embeddings)
#
# # Or, if you have reduced the original embeddings already:
# topic_model.visualize_document_datamap(docs, reduced_embeddings=reduced_embeddings)
# =============================================================================
# Load your custom JSON file with embeddings
# Load the JSON data
with open("out/sample_embeddings/claas-paper.json", "r") as f:
    embedding_data = json.load(f)

# Unwrap the list by accessing the first element
embedding_data = embedding_data[0]

# Extract embeddings from the 'entity' field and store them in a list
embeddings_list = [entry["entity"]["embedding"] for entry in embedding_data]
embeddings = np.array(embeddings_list)

# Prepare documents or labels for the entities
labels = [entry["id"] for entry in embedding_data]

# Define the source embedding (central embedding)
source_embedding = np.array(
    [
        5.14202751e-03,
        5.66691570e-02,
        -4.27120104e-02,
        4.09228988e-02,
        -1.64894443e-02,
        2.37456597e-02,
        -7.66168609e-02,
        1.58509128e-02,
        4.43279557e-03,
        -2.43192576e-02,
        -1.56939514e-02,
        1.04496276e-05,
        1.16364239e-02,
        1.62065439e-02,
        2.65061520e-02,
        -1.41367652e-02,
        4.42858450e-02,
        -5.45900390e-02,
        -4.35110182e-02,
        5.94033999e-03,
        -4.19686250e-02,
        -4.34868503e-03,
        2.31693825e-03,
        4.84876819e-02,
        3.49263586e-02,
        -2.06122305e-02,
        -2.41117254e-02,
        3.70622203e-02,
        -3.11527085e-02,
        -1.64411105e-02,
        1.81125905e-02,
        4.13615629e-03,
        1.07868677e-02,
        2.13695168e-02,
        2.49027039e-06,
        -4.09840234e-02,
        2.07759365e-02,
        2.37218011e-02,
        1.83018744e-02,
        4.46139239e-02,
        3.71591607e-03,
        1.69329774e-02,
        -1.75708979e-02,
        2.56274436e-02,
        -7.21040042e-03,
        2.60903668e-02,
        3.17390263e-02,
        -3.34076732e-02,
        2.52697933e-02,
        6.48244694e-02,
        1.34548880e-02,
        -1.11787673e-02,
        4.04022336e-02,
        2.25838814e-02,
        5.34912087e-02,
        -3.68239842e-02,
        -9.62807517e-03,
        2.76991166e-02,
        5.04057519e-02,
        -8.29681940e-03,
        -3.08840862e-03,
        1.43790040e-02,
        2.13845614e-02,
        5.25879813e-03,
        -3.47301438e-02,
        9.50404257e-03,
        -4.28272272e-03,
        -1.10748783e-02,
        -1.22085377e-03,
        2.75932513e-02,
        -4.97970022e-02,
        -4.11637835e-02,
        4.36602607e-02,
        -1.92885450e-03,
        -3.20137218e-02,
        -2.03256421e-02,
        -2.67652404e-02,
        5.06777801e-02,
        -2.21727639e-02,
        1.67964783e-03,
        5.59753440e-02,
        -4.59620804e-02,
        5.32886311e-02,
        -1.66011024e-02,
        -1.43476846e-02,
        6.17127456e-02,
        8.02378729e-03,
        -1.25136431e-02,
        -3.03885415e-02,
        6.66763913e-03,
        3.01964991e-02,
        -5.90499230e-02,
        4.15995391e-03,
        5.09614609e-02,
        -8.40107910e-03,
        2.09432859e-02,
        -3.80877592e-02,
        -4.11994668e-04,
        4.21298184e-02,
        -5.45323379e-02,
        4.08506095e-02,
        6.53026700e-02,
        -3.29324901e-02,
        6.56334776e-03,
        -6.52824640e-02,
        6.32946715e-02,
        -4.92181331e-02,
        6.73388550e-03,
        -9.68995318e-03,
        2.38373745e-02,
        -5.46241589e-02,
        2.32938537e-03,
        -1.32006230e-02,
        5.01146913e-02,
        -3.17071006e-02,
        3.91698405e-02,
        -1.14601459e-02,
        7.00268447e-02,
        -1.47273124e-03,
        6.85649663e-02,
        -3.99679020e-02,
        -4.67479452e-02,
        -7.38724321e-03,
        2.77729835e-02,
        1.49649642e-02,
        -3.77216898e-02,
        -1.01595484e-02,
        -5.10488413e-02,
        -1.18752941e-02,
        -6.91723153e-02,
        1.90469734e-02,
        -5.71056386e-04,
        -7.13640079e-02,
        -9.28274170e-03,
        2.19914224e-02,
        1.19476371e-01,
        3.29740904e-03,
        1.60801969e-02,
        -7.75081590e-02,
        -4.31093723e-02,
        3.08646839e-02,
        -3.89776081e-02,
        8.19389615e-03,
        -1.05895929e-01,
        -6.24564802e-03,
        3.79746668e-02,
        -7.22066360e-03,
        -6.45934716e-02,
        6.10965397e-03,
        8.40541255e-03,
        -3.22134681e-02,
        3.35613266e-02,
        -1.82824656e-02,
        3.72075513e-02,
        6.72842516e-03,
        2.40397733e-02,
        3.41638969e-03,
        3.82048190e-02,
        5.60243167e-02,
        1.82477552e-02,
        1.04855774e-02,
        -2.04665698e-02,
        2.39049662e-02,
        4.22499068e-02,
        -2.96503827e-02,
        8.38945620e-03,
        -5.19747473e-03,
        2.36040428e-02,
        4.89730330e-04,
        2.60204040e-02,
        3.37655507e-02,
        5.27966283e-02,
        9.13672382e-04,
        3.49813770e-03,
        2.35040160e-03,
        2.67120581e-02,
        1.14770206e-02,
        7.87261203e-02,
        7.98790455e-02,
        -1.69939958e-02,
        3.55661362e-02,
        3.02416109e-03,
        -7.50912502e-02,
        1.49232252e-02,
        -4.94019203e-02,
        2.03568265e-02,
        -3.22825201e-02,
        1.59704518e-02,
        6.68753812e-04,
        -8.11433718e-02,
        -3.08344886e-02,
        2.47067716e-02,
        -2.44838111e-02,
        -1.19469771e-02,
        2.93409359e-02,
        1.18333334e-02,
        -5.25525808e-02,
        2.97762770e-02,
        7.71072833e-03,
        -8.17359909e-02,
        -4.08541784e-02,
        -5.67707233e-02,
        6.33785501e-02,
        5.98905161e-02,
        5.56392632e-02,
        -4.68024872e-02,
        -3.36308554e-02,
        1.07833911e-02,
        -3.69688543e-03,
        -2.41931155e-02,
        4.19465341e-02,
        -8.95864330e-03,
        3.32425395e-03,
        -3.11056543e-02,
        -1.50302118e-02,
        -2.87915990e-02,
        6.97725406e-03,
        8.28345343e-02,
        5.87126426e-03,
        -4.20497358e-02,
        1.90010853e-02,
        -4.97702397e-02,
        -6.55300319e-02,
        7.00178519e-02,
        -2.38781776e-02,
        1.42915873e-02,
        -1.29392724e-02,
        -2.65375455e-03,
        -3.72758281e-04,
        -2.52889674e-02,
        -3.99507321e-02,
        9.92053095e-03,
        5.69876470e-02,
        3.68378754e-03,
        -1.83797535e-02,
        -2.07269825e-02,
        -2.57237963e-02,
        -2.02195942e-02,
        1.57402027e-02,
        -2.64089927e-02,
        -4.28775363e-02,
        3.71136554e-02,
        -2.79285982e-02,
        -2.40717065e-02,
        4.61169034e-02,
        -3.03173196e-02,
        2.19624005e-02,
        2.20145658e-02,
        5.99985942e-02,
        -2.13100258e-02,
        -4.40284088e-02,
        -2.60009151e-02,
        6.78211078e-02,
        -1.11431712e-02,
        3.29806395e-02,
        1.01642041e-02,
        4.91479635e-02,
        2.23148242e-02,
        5.96442260e-03,
        -3.94926220e-02,
        1.37992427e-02,
        -2.34770663e-02,
        4.09132503e-02,
        3.42730200e-03,
        4.06376123e-02,
        -2.60286164e-02,
        -4.41077426e-02,
        -6.23678230e-02,
        4.26473171e-02,
        -2.32344810e-02,
        5.21189123e-02,
        4.79899496e-02,
        5.09593124e-03,
        7.00846454e-03,
        -3.66617017e-03,
        -1.40362764e-02,
        -3.71510658e-04,
        -6.01256732e-03,
        1.73991006e-02,
        3.95088121e-02,
        -4.07283045e-02,
        -7.73718581e-02,
        -3.94478366e-02,
        -1.29975257e-02,
        -5.57972640e-02,
        1.40967863e-02,
        -3.73396501e-02,
        -3.34706120e-02,
        -7.39406571e-02,
        7.10227191e-02,
        4.70796879e-03,
        2.94268671e-02,
        -3.32321711e-02,
        -2.26384439e-02,
        2.57402360e-02,
        -3.47851403e-02,
        3.05978488e-02,
        8.61220434e-02,
        -4.39081863e-02,
        3.37903574e-03,
        6.24379143e-02,
        1.19371545e-02,
        -4.92352061e-02,
        5.63760707e-03,
        3.53732966e-02,
        -3.94822210e-02,
        -4.68139239e-02,
        -4.33738865e-02,
        1.43941799e-02,
        1.06058754e-01,
        -2.25377176e-02,
        6.83298707e-03,
        -4.58805589e-03,
        -3.01689468e-02,
        1.77448653e-02,
        6.48892438e-03,
        7.97986984e-03,
        -2.78774649e-02,
        -1.85284615e-02,
        5.80841452e-02,
        -3.61813158e-02,
        -7.73148090e-02,
        3.14833261e-02,
        -3.82716693e-02,
        -1.09398663e-02,
        1.33785401e-02,
        -1.99256279e-02,
        -5.78956343e-02,
        9.09774080e-02,
        3.28212082e-02,
        2.98069371e-03,
        -1.05351191e-02,
        -4.84990999e-02,
        -2.12107319e-02,
        2.09740810e-02,
        5.36085758e-03,
        -2.98207551e-02,
        9.76280123e-02,
        -6.29348680e-02,
        7.23336684e-03,
        3.60788923e-04,
        -3.09859477e-02,
        -4.39131893e-02,
        2.19001900e-02,
        -2.10461896e-02,
        9.95962881e-03,
        1.69617292e-02,
        -3.03118341e-02,
        4.47062775e-03,
        -3.27302106e-02,
        2.49192491e-02,
        3.93239670e-02,
        2.93108430e-02,
        -4.04521227e-02,
        -2.93823592e-02,
        -3.37261446e-02,
        -5.98899648e-02,
        -6.48478046e-02,
        1.09352451e-02,
        -3.28409933e-02,
        1.27143795e-02,
        4.72338721e-02,
        4.11465615e-02,
        1.25665925e-02,
        -6.49952888e-02,
        1.94977783e-02,
        3.29468809e-02,
        -3.05884201e-02,
        -7.71437362e-02,
        6.21063150e-02,
        6.27384633e-02,
        -9.44864377e-02,
        -3.36230733e-02,
        7.06388354e-02,
        1.77338682e-02,
        -7.73963798e-03,
        4.65952232e-02,
        -3.23179401e-02,
        3.76188755e-02,
        7.76186585e-02,
        4.45745327e-02,
        -6.65953308e-02,
        -2.70052068e-02,
        2.89653689e-02,
        2.22575739e-02,
        -1.20224236e-02,
        -2.92453039e-02,
        1.67568084e-02,
        -8.06382075e-02,
        2.41412986e-02,
        -1.41814715e-04,
        -1.60869434e-02,
        1.37765578e-03,
        -3.29106301e-02,
        -8.33724532e-03,
        6.67564524e-03,
        -3.23204510e-02,
        4.07437049e-02,
        -6.16328977e-03,
        -5.64377801e-03,
        3.35263694e-03,
        -3.29330973e-02,
        3.63173559e-02,
        5.57664968e-02,
        -1.67446844e-02,
        3.93236801e-03,
        7.96832815e-02,
        1.95858739e-02,
        -4.40480141e-03,
        -8.95655621e-03,
        6.20203838e-02,
        7.25388853e-03,
        3.88607159e-02,
        -2.50914060e-02,
        2.12666802e-02,
        3.64124067e-02,
        -1.06349718e-02,
        2.60558520e-02,
        9.82820522e-03,
        -6.22779392e-02,
        -3.16376588e-03,
        3.40748057e-02,
        5.64110167e-02,
        -2.81752367e-02,
        -2.19509676e-02,
        -3.38311009e-02,
        -3.84041220e-02,
        -3.94687764e-02,
        3.16659734e-02,
        3.69770564e-02,
        -2.16599205e-03,
        -7.94969499e-02,
        -6.96913749e-02,
        -4.58653420e-02,
        -4.15578410e-02,
        -2.33346149e-02,
        1.95888653e-02,
        -2.19373479e-02,
        7.57886283e-03,
        -3.51955108e-02,
        7.44164363e-03,
        1.24612022e-02,
        2.74826363e-02,
        3.20902504e-02,
        -4.19592820e-02,
        1.95534271e-03,
        -3.61117348e-02,
        -6.29964620e-02,
        9.39695444e-03,
        -5.68615124e-02,
        5.29924072e-02,
        -5.47809638e-02,
        1.79666132e-02,
        -1.85599420e-02,
        6.31680619e-03,
        -2.61610351e-03,
        2.23747604e-02,
        -9.15320516e-02,
        -6.13889880e-02,
        -1.64967664e-02,
        7.54973218e-02,
        2.50211190e-02,
        9.58639197e-03,
        -2.83963755e-02,
        -4.63338830e-02,
        -6.94329515e-02,
        -1.44896954e-02,
        -2.72800643e-02,
        2.35878993e-02,
        2.77136080e-02,
        -1.55902968e-03,
        2.61010192e-02,
        1.13681741e-02,
        -5.36277853e-02,
        -2.47052545e-03,
        2.58739125e-02,
        8.90111737e-03,
        1.14496201e-02,
        -7.67891353e-04,
        3.98749113e-02,
        3.38739119e-02,
        -3.13680107e-03,
        2.03703512e-02,
        -1.51514886e-02,
        2.90268734e-02,
        2.29608244e-03,
        -7.37609621e-03,
        -1.75191816e-02,
        -5.35209589e-02,
        2.81310771e-02,
        8.41371808e-03,
        -5.48187119e-04,
        3.89827341e-02,
        -9.84322652e-03,
        -1.96902473e-02,
        5.40565588e-02,
        -4.43747677e-02,
        4.05404270e-02,
        -1.80588663e-02,
        1.51397353e-02,
        6.29403293e-02,
        3.84404734e-02,
        -1.45292766e-02,
        4.57820892e-02,
        2.00740434e-02,
        5.07202782e-02,
        -1.22757452e-02,
        3.78091894e-02,
        9.33429133e-03,
        6.60801306e-02,
        -1.12752672e-02,
        -1.82025880e-02,
        -6.73824847e-02,
        -7.43502304e-02,
        6.66027132e-04,
        1.80680063e-02,
        5.47807999e-02,
        1.75241996e-02,
        2.28616744e-02,
        -2.08489057e-02,
        1.50379902e-02,
        -1.82140972e-02,
        2.94100679e-02,
        -1.26041863e-02,
        -1.47006325e-02,
        -1.41316215e-02,
        3.48044634e-02,
        -3.16249439e-03,
        -4.89449464e-02,
        1.00297019e-01,
        2.45896187e-02,
        4.94308621e-02,
        1.60029938e-03,
        -1.26507394e-02,
        -2.87006125e-02,
        1.08631440e-02,
        6.25264794e-02,
        -2.21943799e-02,
        -7.29068788e-03,
        -5.34721203e-02,
        -4.42673899e-02,
        -7.42371902e-02,
        1.03254905e-02,
        4.24946472e-02,
        4.56378311e-02,
        -4.87479568e-02,
        2.15863176e-02,
        5.87009229e-02,
        3.42836305e-02,
        -2.46776566e-02,
        -2.89263930e-02,
        -5.59502048e-04,
        1.53035764e-03,
        -3.36345769e-02,
        -2.73862872e-02,
        -6.06417038e-33,
        -4.11055386e-02,
        -2.11739298e-02,
        3.08540110e-02,
        2.39996146e-02,
        3.08762933e-03,
        -8.67975224e-03,
        -6.37727827e-02,
        1.94773171e-02,
        -8.52094498e-03,
        -2.24664491e-02,
        2.38619708e-02,
        1.37802279e-02,
        -2.31327526e-02,
        -2.41221115e-02,
        6.02017045e-02,
        2.65781935e-02,
        2.86325160e-02,
        1.60220973e-02,
        -6.68459833e-02,
        -2.25778036e-02,
        4.67013288e-03,
        1.78690329e-02,
        1.54932057e-02,
        -3.53000946e-02,
        -2.24203113e-02,
        -3.34799103e-02,
        1.55261746e-02,
        1.11435689e-02,
        -1.46996211e-02,
        3.09111923e-02,
        1.90847814e-02,
        -2.94688735e-02,
        1.13044214e-02,
        -6.49131020e-04,
        -4.76706177e-02,
        -3.68190706e-02,
        -4.94890213e-02,
        -2.56430134e-02,
        3.19941454e-02,
        1.42905174e-03,
        -4.15848903e-02,
        -4.23053093e-02,
        8.89469087e-02,
        2.03477256e-02,
        -6.39356533e-03,
        9.07992537e-04,
        2.39569973e-03,
        -1.48222847e-02,
        -2.02489328e-02,
        -1.95263028e-02,
        -7.38131255e-02,
        3.78359333e-02,
        -3.51357497e-02,
        -2.46920474e-02,
        1.57561507e-02,
        3.17235067e-02,
        -2.16977987e-02,
        2.84959525e-02,
        7.08128046e-03,
        -7.35107251e-03,
        -1.34221222e-02,
        3.42836678e-02,
        5.92539534e-02,
        4.68468480e-03,
        2.29622461e-02,
        2.24370901e-02,
        4.24907058e-02,
        6.16933405e-02,
        -4.40775380e-02,
        2.55372841e-02,
        2.08067447e-02,
        7.89069384e-02,
        1.66628398e-02,
        -2.03898475e-02,
        6.25612354e-03,
        1.70468297e-02,
        -3.54863442e-02,
        2.19530389e-02,
        2.18493845e-02,
        9.14650131e-03,
        -1.87246781e-02,
        4.19469699e-02,
        -4.73218113e-02,
        -3.98985902e-03,
        -5.87209463e-02,
        -1.29700657e-02,
        -1.58842672e-02,
        -3.65599804e-02,
        2.94186082e-02,
        -3.04658338e-02,
        7.16305152e-03,
        -2.74331458e-02,
        -2.27104127e-02,
        -3.68964784e-02,
        -8.83393950e-05,
        -1.72551163e-02,
        -6.43061921e-02,
        4.12107222e-02,
        -4.15491778e-03,
        4.43545058e-02,
        -2.82241628e-02,
        -5.20418696e-02,
        -3.19904126e-02,
        -1.86868012e-02,
        7.47504085e-02,
        9.06612072e-03,
        2.98784338e-02,
        1.47156361e-02,
        -7.52269849e-02,
        4.81813587e-03,
        -6.47724122e-02,
        -1.61063895e-02,
        3.37449531e-03,
        2.87714563e-02,
        2.91709714e-02,
        -2.50653382e-02,
        2.18601692e-02,
        4.67031896e-02,
        1.09955890e-03,
        -2.30971947e-02,
        -4.56615016e-02,
        9.99350753e-03,
        1.02599347e-02,
        1.71872228e-02,
        -3.31873335e-02,
        -5.54198958e-02,
        -6.23138286e-02,
        6.63856417e-02,
        4.81156819e-02,
        -3.40008847e-02,
        -5.06035462e-02,
        4.83528674e-02,
        3.21016842e-07,
        1.70749594e-02,
        1.76462401e-02,
        1.13637242e-02,
        5.96332438e-02,
        2.33216453e-02,
        3.50724012e-02,
        -2.00745855e-02,
        -1.04826977e-02,
        3.90195870e-03,
        -4.11097892e-02,
        -1.79264471e-02,
        -9.82897822e-03,
        4.66049947e-02,
        3.61332856e-03,
        -4.80049700e-02,
        2.54389178e-02,
        -1.14449242e-03,
        7.12990586e-04,
        -3.95735651e-02,
        -1.28761604e-02,
        1.02402375e-03,
        2.61540115e-02,
        8.20386782e-03,
        -4.88307420e-03,
        -1.10635450e-02,
        -5.07248333e-03,
        1.17251612e-02,
        1.83971468e-04,
        -1.66917816e-02,
        8.39337055e-03,
        -6.67118654e-02,
        5.77850230e-02,
        2.20935064e-04,
        -2.81116203e-03,
        -1.78620536e-02,
        -1.56214309e-03,
        1.93211790e-02,
        7.68528953e-02,
        1.50849891e-03,
        5.77635169e-02,
        3.59733030e-02,
        -5.08963242e-02,
        1.34319225e-02,
        -4.05969918e-02,
        2.55178008e-02,
        2.23754644e-02,
        -6.86886860e-03,
        -1.14836562e-02,
        1.27484621e-02,
        1.36854863e-02,
        -3.21842246e-02,
        7.70042138e-03,
        4.44749407e-02,
        1.15108266e-02,
        -7.64909433e-03,
        -3.07091456e-02,
        -4.60261218e-02,
        -1.39623629e-02,
        -4.91043441e-02,
        2.88706664e-02,
        -2.07486041e-02,
        -3.98359150e-02,
        -5.54016568e-02,
        4.53440696e-02,
        -9.69293807e-03,
        -3.03215086e-02,
        -3.14073712e-02,
        3.46909941e-34,
        2.90297624e-02,
        -3.81706730e-02,
        1.93034727e-02,
        2.85792369e-02,
        6.61019683e-02,
        -1.88908260e-02,
        -1.13998000e-02,
        2.84555443e-02,
        -7.38758221e-03,
        9.08145960e-03,
        -2.64234003e-02,
    ],
    dtype=float,
)  # Example: using the first document's embedding as the source

# Train BERTopic model
topic_model = BERTopic().fit(labels, embeddings)

# Reduce dimensionality of embeddings (optional but recommended for visualization)
reduced_embeddings = UMAP(n_neighbors=10, n_components=2, min_dist=0.0, metric="cosine").fit_transform(embeddings)

# Compute the cosine distance between each reduced embedding and the source embedding
distances = cosine_distances(reduced_embeddings, reduced_embeddings[0].reshape(1, -1)).flatten()

# Center the visualization around the source embedding
source_coordinates = reduced_embeddings[0]  # Coordinates of the source embedding after reduction
centered_embeddings = reduced_embeddings - source_coordinates  # Shift all embeddings

# Plot the centered reduced embeddings with distance to the source as colors
plt.figure(figsize=(8, 6))
scatter = plt.scatter(
    centered_embeddings[:, 0], centered_embeddings[:, 1], c=distances, cmap="coolwarm", alpha=0.7, edgecolor="k"
)
plt.colorbar(scatter, label="Distance to Source Embedding")  # Show color mapping for distances
plt.scatter(0, 0, color="red", s=150, label="Source Embedding", edgecolor="black")  # Highlight source at (0, 0)
plt.axhline(0, color="gray", linestyle="--", linewidth=0.5)  # Add horizontal axis line
plt.axvline(0, color="gray", linestyle="--", linewidth=0.5)  # Add vertical axis line
plt.title("Centered Embedding Visualization with Distance to Source")
plt.xlabel("UMAP Dimension 1 (Centered)")
plt.ylabel("UMAP Dimension 2 (Centered)")
plt.legend()
plt.grid(True, alpha=0.3)
plt.show()
